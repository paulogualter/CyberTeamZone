#!/bin/bash
set -euo pipefail

echo "üöÄ Compilando projeto para hospedagem Apache"
echo "============================================="

# Verificar se estamos no diret√≥rio correto
if [ ! -f "package.json" ]; then
    echo "‚ùå Erro: Execute este script na raiz do projeto"
    exit 1
fi

# 1. Limpar builds anteriores
echo "üßπ Limpando builds anteriores..."
rm -rf .next out dist

# 2. Instalar depend√™ncias de produ√ß√£o
echo "üì¶ Instalando depend√™ncias de produ√ß√£o..."
npm ci --omit=dev || npm install --omit=dev

# 3. Fazer build da aplica√ß√£o
echo "üî® Fazendo build da aplica√ß√£o Next.js..."
npm run build

# 4. Criar diret√≥rio de distribui√ß√£o
echo "üìÅ Criando diret√≥rio de distribui√ß√£o..."
mkdir -p dist

# 5. Copiar arquivos necess√°rios para Apache
echo "üìã Copiando arquivos para distribui√ß√£o..."

# Copiar arquivos principais
cp -r .next dist/
cp -r public dist/
cp -r app dist/
cp -r components dist/
cp -r lib dist/
cp -r hooks dist/
cp -r types dist/
cp -r prisma dist/

# Copiar arquivos de configura√ß√£o
cp package.json dist/
cp package-lock.json dist/
cp next.config.js dist/
cp middleware.ts dist/
cp tsconfig.json dist/
cp tailwind.config.js dist/
cp postcss.config.js dist/

# 6. Criar arquivo .htaccess otimizado para Apache
echo "üîê Criando arquivo .htaccess otimizado..."
cat > dist/.htaccess << 'EOF'
# Apache configuration for Next.js on shared hosting
RewriteEngine On

# Security Headers
<IfModule mod_headers.c>
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
</IfModule>

# Protect sensitive files
<Files ".env*">
    Order allow,deny
    Deny from all
</Files>

<Files "*.log">
    Order allow,deny
    Deny from all
</Files>

<Files "package*.json">
    Order allow,deny
    Deny from all
</Files>

# Redirect HTTP to HTTPS
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Handle Next.js routing
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ /index.html [QSA,L]

# Cache static assets
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
</IfModule>

# Gzip compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

# Prevent access to node_modules
RedirectMatch 404 /node_modules/.*
RedirectMatch 404 /\.next/.*
RedirectMatch 404 /\.git/.*
EOF

# 7. Criar arquivo de configura√ß√£o para Node.js
echo "‚öôÔ∏è Criando configura√ß√£o Node.js..."
cat > dist/ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'cyberteam-app',
    script: 'npm',
    args: 'start',
    cwd: process.cwd(),
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true
  }]
}
EOF

# 8. Criar script de instala√ß√£o para Apache
echo "üìù Criando script de instala√ß√£o..."
cat > dist/install-apache.sh << 'EOF'
#!/bin/bash
set -euo pipefail

echo "üöÄ Instalando aplica√ß√£o no Apache..."

# Criar diret√≥rio de logs
mkdir -p logs

# Instalar depend√™ncias
npm ci --omit=dev || npm install --omit=dev

# Gerar cliente Prisma
npx prisma generate --schema=prisma/schema.prisma

# Aplicar migra√ß√µes (se necess√°rio)
# npx prisma db push --schema=prisma/schema.prisma

# Criar diret√≥rio de uploads
mkdir -p public/uploads
chmod 755 public/uploads

# Configurar permiss√µes
chmod 644 .htaccess
chmod 755 public/uploads
chmod 644 package.json

echo "‚úÖ Instala√ß√£o conclu√≠da!"
echo "üìù Pr√≥ximos passos:"
echo "1. Configure as vari√°veis de ambiente no .env.local"
echo "2. Configure o banco de dados MySQL"
echo "3. Configure o Node.js no painel da Hostinger"
echo "4. Configure o dom√≠nio e SSL"
EOF

chmod +x dist/install-apache.sh

# 9. Criar arquivo de vari√°veis de ambiente de exemplo
echo "üîê Criando arquivo de vari√°veis de ambiente..."
cat > dist/.env.example << 'EOF'
# Database (substitua pelas credenciais do seu banco)
DATABASE_URL="mysql://cyberteamlms:cyberteamLms@localhost:3306/cyberteamlms"

# NextAuth
NEXTAUTH_URL="https://seu-dominio.com"
NEXTAUTH_SECRET="seu-secret-super-seguro-aqui-minimo-32-caracteres"

# Google OAuth
GOOGLE_CLIENT_ID="seu-google-client-id"
GOOGLE_CLIENT_SECRET="seu-google-client-secret"

# Stripe
STRIPE_PUBLISHABLE_KEY="pk_live_..."
STRIPE_SECRET_KEY="sk_live_..."
STRIPE_WEBHOOK_SECRET="whsec_..."

# Mercado Pago (opcional)
MERCADOPAGO_ACCESS_TOKEN="seu-mercadopago-token"
MERCADOPAGO_WEBHOOK_SECRET="seu-mercadopago-webhook-secret"
EOF

# 10. Criar arquivo de instru√ß√µes espec√≠ficas para Apache
echo "üìã Criando instru√ß√µes de deploy para Apache..."
cat > dist/INSTRUCOES_APACHE.md << 'EOF'
# üöÄ Deploy no Apache - Hostinger Hospedagem Compartilhada

## üìã Pr√©-requisitos

- Conta na Hostinger com hospedagem compartilhada
- Acesso ao painel de controle (hPanel)
- Banco de dados MySQL criado
- Dom√≠nio configurado

## üîß Configura√ß√£o

### 1. Upload dos Arquivos
- Fa√ßa upload de **TODOS** os arquivos da pasta `dist/` para `public_html`
- Mantenha a estrutura de pastas

### 2. Configurar Banco de Dados
1. No hPanel, v√° em "Bancos de Dados MySQL"
2. Crie um banco de dados:
   - Nome: `cyberteamlms`
   - Usu√°rio: `cyberteamlms`
   - Senha: `cyberteamLms`
3. Anote o host do banco

### 3. Configurar Vari√°veis de Ambiente
1. Renomeie `.env.example` para `.env.local`
2. Edite com suas credenciais reais
3. Substitua `seu-dominio.com` pelo seu dom√≠nio

### 4. Configurar Node.js
1. No hPanel, v√° em "Node.js"
2. Selecione vers√£o Node.js 18+
3. Configure:
   - Comando: `npm start`
   - Pasta: `public_html`
   - Porta: `3000`

### 5. Executar Instala√ß√£o
1. Acesse o terminal via SSH
2. Execute: `bash install-apache.sh`

### 6. Configurar SSL
1. No hPanel, ative SSL
2. Configure redirecionamento HTTP ‚Üí HTTPS

## üîß Comandos √öteis

```bash
# Ver logs
pm2 logs cyberteam-app

# Reiniciar
pm2 restart cyberteam-app

# Status
pm2 status
```

## ‚ö†Ô∏è Importante

- O arquivo `.htaccess` est√° configurado para Next.js
- As rotas API funcionam via Node.js
- P√°ginas est√°ticas s√£o servidas pelo Apache
- P√°ginas din√¢micas s√£o servidas pelo Node.js

## üÜò Troubleshooting

### Erro 500
- Verifique se o Node.js est√° rodando
- Confirme as vari√°veis de ambiente
- Verifique os logs: `pm2 logs cyberteam-app`

### Erro de Banco
- Confirme as credenciais no .env.local
- Verifique se o banco foi criado

### Erro de Permiss√µes
- Verifique permiss√µes dos arquivos (644/755)
- Confirme se .env.local tem permiss√µes corretas
EOF

# 11. Criar arquivo de configura√ß√£o do Next.js otimizado para Apache
echo "‚öôÔ∏è Criando configura√ß√£o Next.js otimizada..."
cat > dist/next.config.apache.js << 'EOF'
/** @type {import('next').NextConfig} */
const nextConfig = {
  // Configura√ß√£o otimizada para Apache
  output: 'standalone',
  
  // Configura√ß√£o de imagens
  images: {
    domains: ['lh3.googleusercontent.com', 'images.unsplash.com', 'via.placeholder.com'],
    unoptimized: true // Para hospedagem compartilhada
  },
  
  // Configura√ß√£o de headers para Apache
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'X-Frame-Options',
            value: 'DENY'
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff'
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin'
          }
        ]
      }
    ]
  },
  
  // Configura√ß√£o de redirecionamentos
  async redirects() {
    return [
      {
        source: '/admin',
        destination: '/admin/courses',
        permanent: false
      }
    ]
  },
  
  // Configura√ß√£o de rewrites para API
  async rewrites() {
    return [
      {
        source: '/api/:path*',
        destination: '/api/:path*'
      }
    ]
  },
  
  // Configura√ß√£o de ambiente
  env: {
    NEXTAUTH_URL: process.env.NEXTAUTH_URL || 'http://localhost:3000',
    NEXTAUTH_SECRET: process.env.NEXTAUTH_SECRET,
    GOOGLE_CLIENT_ID: process.env.GOOGLE_CLIENT_ID,
    GOOGLE_CLIENT_SECRET: process.env.GOOGLE_CLIENT_SECRET,
    DATABASE_URL: process.env.DATABASE_URL,
    STRIPE_SECRET_KEY: process.env.STRIPE_SECRET_KEY,
    STRIPE_PUBLISHABLE_KEY: process.env.STRIPE_PUBLISHABLE_KEY,
    STRIPE_WEBHOOK_SECRET: process.env.STRIPE_WEBHOOK_SECRET,
    MERCADOPAGO_ACCESS_TOKEN: process.env.MERCADOPAGO_ACCESS_TOKEN,
  },
  
  // Configura√ß√£o de build
  generateBuildId: async () => {
    return 'cyberteam-build-' + Date.now()
  },
  
  // Configura√ß√£o de compress√£o
  compress: true,
  
  // Configura√ß√£o de power
  poweredByHeader: false,
  
  // Configura√ß√£o de trailing slash
  trailingSlash: false,
  
  // Configura√ß√£o de experimental
  experimental: {
    optimizeCss: true,
    optimizePackageImports: ['@heroicons/react']
  }
}

module.exports = nextConfig
EOF

# 12. Criar script de build final
echo "üì¶ Criando script de build final..."
cat > dist/build-final.sh << 'EOF'
#!/bin/bash
set -euo pipefail

echo "üî® Executando build final para Apache..."

# Instalar depend√™ncias
npm ci --omit=dev

# Gerar cliente Prisma
npx prisma generate --schema=prisma/schema.prisma

# Fazer build final
npm run build

# Criar diret√≥rios necess√°rios
mkdir -p logs
mkdir -p public/uploads

# Configurar permiss√µes
chmod 755 public/uploads
chmod 644 .htaccess
chmod 644 package.json

echo "‚úÖ Build final conclu√≠do!"
echo "üöÄ Aplica√ß√£o pronta para deploy no Apache!"
EOF

chmod +x dist/build-final.sh

# 13. Criar arquivo de verifica√ß√£o
echo "üîç Criando arquivo de verifica√ß√£o..."
cat > dist/verify-deployment.sh << 'EOF'
#!/bin/bash
set -euo pipefail

echo "üîç Verificando deployment..."

# Verificar se os arquivos essenciais existem
echo "üìÅ Verificando arquivos essenciais..."
[ -f "package.json" ] && echo "‚úÖ package.json" || echo "‚ùå package.json"
[ -f ".htaccess" ] && echo "‚úÖ .htaccess" || echo "‚ùå .htaccess"
[ -f "next.config.js" ] && echo "‚úÖ next.config.js" || echo "‚ùå next.config.js"
[ -f ".env.local" ] && echo "‚úÖ .env.local" || echo "‚ùå .env.local"

# Verificar se as pastas existem
echo "üìÅ Verificando pastas..."
[ -d ".next" ] && echo "‚úÖ .next" || echo "‚ùå .next"
[ -d "public" ] && echo "‚úÖ public" || echo "‚ùå public"
[ -d "app" ] && echo "‚úÖ app" || echo "‚ùå app"
[ -d "components" ] && echo "‚úÖ components" || echo "‚ùå components"

# Verificar permiss√µes
echo "üîê Verificando permiss√µes..."
[ -r ".htaccess" ] && echo "‚úÖ .htaccess leg√≠vel" || echo "‚ùå .htaccess n√£o leg√≠vel"
[ -w "public/uploads" ] && echo "‚úÖ public/uploads grav√°vel" || echo "‚ùå public/uploads n√£o grav√°vel"

# Verificar Node.js
echo "üü¢ Verificando Node.js..."
node --version && echo "‚úÖ Node.js instalado" || echo "‚ùå Node.js n√£o instalado"

# Verificar npm
echo "üì¶ Verificando npm..."
npm --version && echo "‚úÖ npm instalado" || echo "‚ùå npm n√£o instalado"

echo "‚úÖ Verifica√ß√£o conclu√≠da!"
EOF

chmod +x dist/verify-deployment.sh

# 14. Criar arquivo de limpeza
echo "üßπ Criando arquivo de limpeza..."
cat > dist/cleanup.sh << 'EOF'
#!/bin/bash
set -euo pipefail

echo "üßπ Limpando arquivos desnecess√°rios..."

# Remover arquivos de desenvolvimento
rm -rf node_modules/.cache
rm -rf .next/cache
rm -rf logs/*.log

# Remover arquivos tempor√°rios
find . -name "*.tmp" -delete
find . -name "*.temp" -delete

# Remover arquivos de backup
find . -name "*.backup" -delete
find . -name "*.bak" -delete

echo "‚úÖ Limpeza conclu√≠da!"
EOF

chmod +x dist/cleanup.sh

# 15. Criar arquivo README final
echo "üìñ Criando README final..."
cat > dist/README.md << 'EOF'
# üöÄ CyberTeam.Zone - Deploy Apache

## üìã Arquivos Inclu√≠dos

- `.next/` - Build da aplica√ß√£o Next.js
- `public/` - Arquivos est√°ticos
- `app/` - P√°ginas da aplica√ß√£o
- `components/` - Componentes React
- `lib/` - Bibliotecas e utilit√°rios
- `hooks/` - React hooks customizados
- `types/` - Defini√ß√µes TypeScript
- `prisma/` - Schema do banco de dados
- `.htaccess` - Configura√ß√£o Apache
- `ecosystem.config.js` - Configura√ß√£o PM2
- `package.json` - Depend√™ncias Node.js

## üöÄ Deploy R√°pido

1. **Upload**: Fa√ßa upload de todos os arquivos para `public_html`
2. **Configurar**: Renomeie `.env.example` para `.env.local` e configure
3. **Instalar**: Execute `bash install-apache.sh`
4. **Verificar**: Execute `bash verify-deployment.sh`

## üîß Comandos √öteis

```bash
# Instalar depend√™ncias
bash install-apache.sh

# Verificar deployment
bash verify-deployment.sh

# Limpeza
bash cleanup.sh

# Build final
bash build-final.sh
```

## üìû Suporte

Para problemas ou d√∫vidas, consulte:
- `INSTRUCOES_APACHE.md` - Instru√ß√µes detalhadas
- Logs da aplica√ß√£o via PM2
- Painel de controle da Hostinger

## ‚ö†Ô∏è Importante

- Mantenha o arquivo `.env.local` seguro
- Configure SSL no painel da Hostinger
- Monitore os logs regularmente
- Fa√ßa backup do banco de dados
EOF

echo "‚úÖ Compila√ß√£o para Apache conclu√≠da!"
echo ""
echo "üìÅ Arquivos compilados em: dist/"
echo "üìã Pr√≥ximos passos:"
echo "1. Fa√ßa upload da pasta dist/ para public_html na Hostinger"
echo "2. Configure as vari√°veis de ambiente"
echo "3. Execute o script de instala√ß√£o"
echo "4. Configure o Node.js no painel da Hostinger"
echo ""
echo "üìÅ Arquivos criados:"
echo "- dist/ (pasta completa para upload)"
echo "- .htaccess (configura√ß√£o Apache)"
echo "- ecosystem.config.js (configura√ß√£o PM2)"
echo "- install-apache.sh (script de instala√ß√£o)"
echo "- verify-deployment.sh (script de verifica√ß√£o)"
echo "- cleanup.sh (script de limpeza)"
echo "- INSTRUCOES_APACHE.md (instru√ß√µes detalhadas)"
echo "- README.md (documenta√ß√£o)"
